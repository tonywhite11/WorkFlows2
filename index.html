<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WorkFlows - AI-Powered Planning Assistant</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        html, body {
            height: 100%;
        }
        body {
            min-height: 100vh;
            margin: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #1a202c;
        }
        .container {
            max-width: 700px;
            margin: 40px auto;
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 8px 32px rgba(76, 81, 255, 0.08);
            padding: 36px 32px 32px 32px;
            position: relative; /* For positioning the dark mode toggle */
        }
        .header {
            text-align: center;
            color: #5a67d8;
            margin-bottom: 8px;
        }
        .subtitle {
            text-align: center;
            color: #4a5568;
            margin-bottom: 32px;
        }
        label {
            font-weight: 600;
            margin-bottom: 6px;
            display: block;
        }
        input, select, textarea { /* Select will be unused if role buttons are implemented */
            width: 100%;
            padding: 12px;
            margin-bottom: 18px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            font-size: 16px;
            background: #f8fafc;
            box-sizing: border-box;
        }
        
        /* General Button Styles (Light Mode - Base) */
        button, .mode-toggle {
            padding: 12px 24px; /* Slightly adjusted default padding */
            border: none;
            border-radius: 8px; /* Default to more professional radius */
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            color: white;
            transition: all 0.3s ease;
            margin-top: 10px;
            background: #4F46E5; /* Default to professional indigo */
        }
        button:hover, .mode-toggle:hover {
            background: #4338CA; /* Darker indigo on hover */
        }

        /* Specific style for the "Generate Workflow" button */
        #generateBtn {
            padding: 12px 28px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 16px;
            background: #10B981; /* Refined professional green */
            color: white;
            border: none;
            transition: background-color 0.3s ease;
            background-image: none; /* Ensure no gradient */
            width: 100%; /* Make it full width like inputs */
            box-sizing: border-box;
        }
        #generateBtn:hover {
            background: #059669;
            background-image: none;
        }

        .workflow-preview {
            background: #f8fafc;
            border-radius: 12px;
            padding: 24px;
            margin-top: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(90,103,216,0.07);
        }
        .step {
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid #e2e8f0;
        }
        .step:last-child {
            border-bottom: none;
        }
        .step-title {
            font-weight: 700;
            color: #5a67d8;
            margin-bottom: 6px;
        }
        .step-status {
            color: green;
            font-weight: bold;
            margin-left: 10px;
            font-size: 0.9em;
        }
        .coach-mode {
            background: #f0fff4;
            border-radius: 12px;
            padding: 24px;
            margin-top: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(72,187,120,0.07);
        }
        .coach-controls {
            margin-top: 18px;
            margin-bottom: 18px;
        }
        .coach-btn { /* Coach mode specific buttons */
            padding: 10px 18px;
            border: none;
            border-radius: 8px; /* Updated radius */
            background: #10B981; /* Refined Green */
            color: white;
            font-weight: 600;
            margin-right: 10px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .coach-btn:hover {
            background: #059669; /* Darker refined green */
        }
        #chatMessages {
            max-height: 180px;
            overflow-y: auto;
            background: #fff;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid #e2e8f0;
            font-size: 15px;
        }
        #chatInput {
            width: calc(70% - 5px);
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            font-size: 15px;
            margin-right: 5px;
        }
        .hidden { display: none !important; }
        .loading {
            text-align: center;
            color: #5a67d8;
            font-weight: 600;
            margin-top: 20px;
        }
        .editable[contenteditable="true"] {
            background-color: #e0f2fe;
            padding: 5px;
            border: 1px dashed #3b82f6;
            outline: none;
            display: inline-block;
            min-width: 50px;
        }
        .edit-step-btn, .save-step-btn {
            padding: 6px 12px;
            font-size: 13px;
            margin-top: 8px;
            border-radius: 6px; /* Sharper radius */
        }
        .save-step-btn { background: #059669; color:white; } /* Using refined green */
        .edit-step-btn { background: #4F46E5; color:white; } /* Using indigo */

        #downloadButtons button {
            font-size: 14px;
            padding: 10px 20px;
            border-radius: 8px; /* Consistent radius */
            background: #4F46E5; /* Indigo */
        }
         #downloadButtons button:hover {
            background: #4338CA; /* Darker Indigo */
        }

        #clearStorageBtn {
            background: #EF4444; /* Brighter, clearer red */
            color: white;
            font-size:14px;
            padding: 10px 20px;
            border-radius: 8px;
        }
         #clearStorageBtn:hover {
            background: #DC2626; /* Darker red */
        }

        /* === Role Buttons (Light Mode) === */
        .role-buttons-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 24px; /* Increased margin for spacing */
        }
        .role-btn {
            padding: 8px 16px;
            font-size: 14px;
            border: 1px solid #D1D5DB; /* Softer grey border */
            border-radius: 8px; /* Reduced border-radius */
            background-color: #F9FAFB; /* Very light grey, almost white */
            color: #374151; /* Darker, more muted text */
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-top: 0;
            font-weight: 500;
        }
        .role-btn:hover {
            background-color: #F3F4F6;
            border-color: #9CA3AF;
        }
        .role-btn.selected {
            background-color: #4F46E5; /* Professional indigo */
            color: white;
            border-color: #4F46E5;
            font-weight: 600;
        }

        @media (max-width: 700px) {
            .container { padding: 20px 15px; margin: 20px 10px; }
            #chatInput { width: calc(60% - 5px); }
            #darkModeToggle { top: 10px !important; right: 10px !important; } /* Adjust for smaller screens */
        }

        /* === Dark Mode Styles === */
        body.dark-mode {
            background: linear-gradient(135deg, #1F2937 0%, #111827 100%); /* Darker, more neutral gradient */
            color: #D1D5DB; /* Light grey text */
        }
        body.dark-mode .container {
            background: #1F2937; /* Dark grey container */
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4); /* Darker shadow */
            color: #D1D5DB;
        }
        body.dark-mode .header {
            color: #93C5FD; /* Lighter blue for header */
        }
        body.dark-mode .subtitle {
            color: #9CA3AF; /* Lighter grey for subtitle */
        }
        body.dark-mode label {
            color: #D1D5DB;
        }
        body.dark-mode input, 
        body.dark-mode select, /* Will be unused if role buttons are used */
        body.dark-mode textarea {
            background: #111827; /* Very dark input background */
            border: 1px solid #374151; /* Grey border */
            color: #D1D5DB; /* Light text in inputs */
        }
        body.dark-mode input::placeholder,
        body.dark-mode textarea::placeholder {
            color: #6B7280; /* Muted placeholder text */
        }
        
        /* General action buttons and mode toggles in Dark Mode */
        body.dark-mode button, 
        body.dark-mode .mode-toggle {
            background: #374151; /* Solid dark grey */
            color: #D1D5DB; /* Light text */
            background-image: none; 
        }
        body.dark-mode button:hover,
        body.dark-mode .mode-toggle:hover {
            background: #4B5563; /* Lighter grey on hover */
        }

        /* Specific style for the "Generate Workflow" button in dark mode */
        body.dark-mode #generateBtn {
            background: #10B981; /* Refined Green */
            color: white;
            background-image: none;
        }
        body.dark-mode #generateBtn:hover {
            background: #059669; /* Darker refined green */
        }

        /* Dark mode Download buttons */
        body.dark-mode #downloadButtons button {
            background: #4F46E5; /* Indigo */
            color: white;
            background-image: none;
        }
        body.dark-mode #downloadButtons button:hover {
            background: #4338CA; /* Darker Indigo */
        }
        
        /* Coach Mode action buttons */
        body.dark-mode .coach-btn {
            background: #059669; /* Darker Solid refined green */
            color: white;
            background-image: none;
        }
        body.dark-mode .coach-btn:hover {
            background: #047857; /* Even darker green */
        }
        body.dark-mode .coach-mode button[onclick="downloadCoachPDF()"] { 
            background: #4B5563; /* Neutral dark grey */
            color: #D1D5DB;
        }
         body.dark-mode .coach-mode button[onclick="downloadCoachPDF()"]:hover {
            background: #374151; /* Darker grey */
        }
        
        body.dark-mode #clearStorageBtn {
            background: #DC2626; /* Solid darker red */
            color: white;
            background-image: none; 
        }
        body.dark-mode #clearStorageBtn:hover {
            background: #B91C1C; /* Even darker red */
        }

        body.dark-mode .workflow-preview {
            background: #111827; /* Very dark background for preview */
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            color: #9CA3AF; /* Lighter text */
        }
        body.dark-mode .step {
            border-bottom: 1px solid #374151; /* Darker border for steps */
        }
        body.dark-mode .step-title {
            color: #93C5FD; /* Lighter blue for step titles */
        }
        body.dark-mode .coach-mode {
            background: #1F2937; /* Darker for coach mode */
            box-shadow: 0 2px 8px rgba(0,0,0,0.25);
            color: #9CA3AF;
        }
        body.dark-mode #chatMessages {
            background: #111827;
            border: 1px solid #374151;
            color: #D1D5DB;
        }
        body.dark-mode #chatInput {
            background: #1F2937; /* Match container dark */
            border: 1px solid #374151;
            color: #D1D5DB;
        }
        body.dark-mode .loading {
            color: #93C5FD;
        }
        body.dark-mode .editable[contenteditable="true"] {
            background-color: #374151; /* Darker highlight for editing */
            border: 1px dashed #60A5FA;
        }
        
        /* Dark mode toggle button itself */
        /* Uses the general dark mode button style by default, which is fine */
        /* If specific override needed: */
        /* body.dark-mode #darkModeToggle {
            background: #4B5563;
            color: #D1D5DB;
            border: 1px solid #6B7280;
        } */

        /* === Dark Mode - Role Buttons === */
        body.dark-mode .role-btn {
            background-color: #374151; /* Dark grey background */
            border: 1px solid #4B5563; /* Slightly lighter border */
            color: #D1D5DB; /* Light grey text */
            font-weight: 500;
        }
        body.dark-mode .role-btn:hover {
            background-color: #4B5563; /* Lighter on hover */
            border-color: #6B7280;
        }
        body.dark-mode .role-btn.selected {
            background-color: #6366F1; /* Brighter indigo for dark mode selection */
            color: white; 
            border-color: #6366F1;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>WorkFlows</h1>
        </div>
        <div class="subtitle">AI-Powered Project Planning & Coaching</div>
        <button id="darkModeToggle" style="position: absolute; top: 20px; right: 20px; padding: 8px 12px; font-size: 12px; border-radius: 20px; background: #e2e8f0; color: #2d3748; border: 1px solid #cbd5e0; cursor: pointer;">🌙 Toggle Theme</button>
        <div id="inputSection">
            <label for="goal">What's your goal?</label>
            <textarea id="goal" rows="2" placeholder="e.g., Launch an Etsy store"></textarea>
            <label for="role">Select Role</label>
            <label for="roleSelection">Select Your Role</label>
            <div id="roleSelection" class="role-buttons-container">
                <!-- Buttons will be generated by JavaScript, or you can hardcode them -->
                <!-- Example of one button if hardcoding: -->
                <!-- <button type="button" class="role-btn" data-role="Generalist">🎯 Generalist</button> -->
            </div>
            <label for="region">Your location or region (optional)</label>
            <input id="region" type="text" placeholder="e.g., United States, UK, India">
            <button onclick="onGenerate()" id="generateBtn">🚀 Generate Workflow</button>
        </div>
        <div id="loading" class="loading hidden">Generating workflow... <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cGF0aCBkPSJNMTIgMkM2LjQ3NzE1IDIgMiA2LjQ3NzE1IDIgMTJD MiAxNy41MjI4IDYuNDc3MTUgMjIgMTIgMjJDMTcuNTIyOCAyMiAyMiAxNy41MjI4IDIyIDEyQzIyIDEwLjU1NCAyMS43MzQ0IDkuMTg3NDcgMjEuMjgyMiA3LjkzOTg4IiBzdHJva2U9IiM1QTY3RDgiIHN0cm9rZS13aWR0aD0iMyIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIi8+Cjwvc3ZnPgo=" alt="loading" style="width:20px; height:20px; vertical-align:middle; animation: spin 1s linear infinite;"></div>
        <style>@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }</style>

        <div id="workflowPreview" class="workflow-preview hidden"></div>
        <div id="downloadButtons" class="hidden" style="margin-top: 15px; text-align: center;">
            <button onclick="downloadWorkflowPDF()" id="downloadPdfBtn" style="margin-right: 10px; background: #5a67d8;">Download PDF</button>
            <button onclick="downloadWorkflowJSON()" id="downloadJsonBtn" style="background: #5a67d8;">Download JSON</button>
        </div>
        <button class="mode-toggle hidden" id="coachModeBtn" onclick="enterCoachMode()">🧭 Enter Coach Mode</button>
        
        <div class="coach-mode hidden" id="coachMode">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom:15px;">
                <button class="mode-toggle" onclick="exitCoachMode()">← Back to Workflow</button>
                <button onclick="downloadCoachPDF()" class="coach-btn" style="background-color: #718096;">Download Chat Log</button>
            </div>
            <h3>🧭 Coach Mode: Current Step</h3>
            <div id="currentStep"></div>
            <div class="coach-controls">
                <button class="coach-btn" onclick="previousStep()">← Previous</button>
                <button class="coach-btn" onclick="completeCurrentStep()">Mark Complete</button>
                <button class="coach-btn" onclick="nextStep()">Next →</button>
            </div>
            <div id="coachChat" style="margin-top:30px;">
                <div id="chatMessages"></div>
                <input id="chatInput" type="text" placeholder="Ask your coach for help...">
                <button onclick="sendCoachMessage()" class="coach-btn" style="margin-left:0px;">Send</button>
            </div>
        </div>
    </div>
    <script>
    // --- GLOBAL STATE ---
    let workflowData = null; // { workflowTitle: "...", steps: [...], total_estimated_cost: "...", summary: "..." }
    let currentStepIndex = 0;
    let currentlyEditingStep = null;
    let selectedRole = 'Generalist'; // Default role
    const backendBaseUrl = "https://workflows2-backend.onrender.com"; // Your Render backend URL
    // const backendBaseUrl = "http://localhost:8000"; // Uncomment for local development

    const roles = [ // Define your roles, optionally with icons
        { name: 'Generalist', icon: '🎯' }, { name: 'Developer', icon: '💻' },
        { name: 'Designer', icon: '🎨' }, { name: 'Marketer', icon: '📈' },
        { name: 'Coach', icon: '🧭' }, { name: 'Entrepreneur', icon: '🚀' },
        { name: 'Student', icon: '📚' }, { name: 'Researcher', icon: '🔬' },
        { name: 'Content Creator', icon: '🎬' }, { name: 'Event Planner', icon: '🎉' },
        { name: 'HR Specialist', icon: '👥' }, { name: 'Teacher', icon: '🧑‍🏫' },
        { name: 'Consultant', icon: '💼' }, { name: 'Healthcare Professional', icon: '⚕️' },
        { name: 'Engineer', icon: '⚙️' }, { name: 'Writer', icon: '✍️' },
        { name: 'Salesperson', icon: '🤝' }, { name: 'Financial Advisor', icon: '💰' }
    ];

    // Function to create and render role buttons
    function renderRoleButtons() {
        const container = document.getElementById('roleSelection');
        if (!container) return;
        container.innerHTML = ''; // Clear existing buttons

        roles.forEach(role => {
            const button = document.createElement('button');
            button.type = 'button'; // Important to prevent form submission if inside a form
            button.classList.add('role-btn');
            button.dataset.role = role.name; // Store role name in data attribute
            button.innerHTML = `${role.icon ? `<span>${role.icon}</span>` : ''} ${role.name}`;

            if (role.name === selectedRole) {
                button.classList.add('selected');
            }

            button.addEventListener('click', function() {
                // Remove 'selected' class from previously selected button
                const currentSelected = container.querySelector('.role-btn.selected');
                if (currentSelected) {
                    currentSelected.classList.remove('selected');
                }
                // Add 'selected' class to the clicked button
                this.classList.add('selected');
                selectedRole = this.dataset.role; // Update the global selectedRole variable
            });
            container.appendChild(button);
        });
    }

    // --- DARK MODE TOGGLE ---
    const darkModeToggle = document.getElementById('darkModeToggle');

    // Function to set the theme
    function setTheme(isDark) {
        if (isDark) {
            document.body.classList.add('dark-mode');
            darkModeToggle.textContent = '☀️ Light Mode';
            localStorage.setItem('theme', 'dark');
        } else {
            document.body.classList.remove('dark-mode');
            darkModeToggle.textContent = '🌙 Dark Mode';
            localStorage.setItem('theme', 'light');
        }
    }

    // Event listener for the toggle
    darkModeToggle.addEventListener('click', () => {
        const isDarkMode = document.body.classList.contains('dark-mode');
        setTheme(!isDarkMode); // Toggle the theme
    });

    // Function to apply saved theme on load
    function applySavedTheme() {
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            setTheme(true);
        } else {
            setTheme(false); // Default to light if no preference or 'light'
        }
    }

    // +++ HELPER FUNCTION TO MANAGE THE CLEAR STORAGE BUTTON +++
    function manageClearStorageButton() {
        const inputSection = document.getElementById('inputSection');
        let clearBtn = document.getElementById('clearStorageBtn');
        const hasSavedData = localStorage.getItem('workflowApp_workflowData');

        if (hasSavedData) {
            if (!clearBtn) { // If button doesn't exist, create and append it
                clearBtn = document.createElement('button');
                clearBtn.id = 'clearStorageBtn';
                clearBtn.textContent = 'Clear Saved & Start New';
                clearBtn.style.marginTop = "15px"; // Added some margin for better spacing
                clearBtn.onclick = () => {
                    if (confirm("Are you sure you want to clear your saved workflow and start over?")) {
                        localStorage.removeItem('workflowApp_workflowData');
                        localStorage.removeItem('workflowApp_currentStepIndex');
                        workflowData = null;
                        currentStepIndex = 0;
                        document.getElementById('workflowPreview').innerHTML = '';
                        document.getElementById('workflowPreview').classList.add('hidden');
                        document.getElementById('coachModeBtn').classList.add('hidden');
                        document.getElementById('downloadButtons').classList.add('hidden');
                        document.getElementById('coachMode').classList.add('hidden');
                        document.getElementById('goal').value = '';
                        document.getElementById('region').value = '';
                        alert('Cleared saved workflow.');
                        if (clearBtn) clearBtn.remove(); // Remove the button itself
                    }
                };
                if (inputSection) {
                    inputSection.appendChild(clearBtn);
                }
            }
        } else {
            if (clearBtn) { // If button exists but no data, remove it
                clearBtn.remove();
            }
        }
    }

    // --- MARKDOWN TO HTML ---
    function markdownToHtml(text) {
        if (!text) return "";
        text = text.replace(/\[([^\]]+)\]\((https?:\/\/[^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>');
        text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
        return text;
    }

    // --- GENERATE WORKFLOW ---
    async function onGenerate() {
        const goal = document.getElementById('goal').value.trim();
        // const role = document.getElementById('role').value; // OLD WAY - REMOVE THIS
        const role = selectedRole; // NEW WAY - Use the global variable
        const region = document.getElementById('region').value.trim();
        if (!goal) {
            alert("Please enter your goal.");
            return;
        }
        document.getElementById('loading').classList.remove('hidden');
        document.getElementById('workflowPreview').classList.add('hidden');
        document.getElementById('coachModeBtn').classList.add('hidden');
        document.getElementById('downloadButtons').classList.add('hidden');
        document.getElementById('coachMode').classList.add('hidden');
        
        try {
            const res = await fetch(`${backendBaseUrl}/generate-workflow`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ goal, role, region })
            });
            if (!res.ok) {
                const errorData = await res.json();
                throw new Error(errorData.detail?.error || `HTTP error! Status: ${res.status}`);
            }
            const data = await res.json();
            
            workflowData = data;
            currentStepIndex = 0;
            workflowData.steps.forEach(step => {
                if (typeof step.completed === 'undefined') step.completed = false;
            });

            renderWorkflowPreview();
            document.getElementById('workflowPreview').classList.remove('hidden');
            document.getElementById('coachModeBtn').classList.remove('hidden');
            document.getElementById('downloadButtons').classList.remove('hidden');
            saveStateToLocalStorage();
            manageClearStorageButton(); // <--- Called after successful generation and save

        } catch (e) {
            alert("Error generating workflow: " + e.message + (e.raw_response ? `\nRaw: ${e.raw_response}`: ''));
            console.error("Error in onGenerate:", e);
        }
        document.getElementById('loading').classList.add('hidden');
    }

    // --- RENDER WORKFLOW PREVIEW ---
    function renderWorkflowPreview() {
        const preview = document.getElementById('workflowPreview');
        if (!workflowData || !workflowData.steps || !workflowData.steps.length) {
            preview.innerHTML = "<em>No workflow generated yet.</em>";
            return;
        }

        let html = `<h2>${markdownToHtml(workflowData.workflowTitle || 'Workflow')}</h2>`;
        if (workflowData.summary) {
            html += `<p style="font-style: italic;">${markdownToHtml(workflowData.summary)}</p>`;
        }
        if (workflowData.total_estimated_cost) {
            html += `<p><strong>Total Estimated Cost:</strong> ${markdownToHtml(workflowData.total_estimated_cost)}</p>`;
        }
        html += `<hr style="margin: 20px 0;">`;

        workflowData.steps.forEach((step, idx) => {
            let toolsHtml = "N/A";
            if (step.tools && step.tools.length > 0) {
                toolsHtml = "<ul>";
                step.tools.forEach(tool => {
                    toolsHtml += `<li>${tool.url ? `<a href="${tool.url}" target="_blank" rel="noopener">${markdownToHtml(tool.name)}</a>` : markdownToHtml(tool.name)}</li>`;
                });
                toolsHtml += "</ul>";
            } else if (typeof step.tools === 'string' && step.tools) {
                toolsHtml = markdownToHtml(step.tools);
            }
            
            const completedStatus = step.completed ? '<span class="step-status">✅ Completed</span>' : '<span class="step-status"></span>';

            html += `<div class="step" id="step-preview-${idx}">
                <div class="step-title">Step ${step.step_number || (idx + 1)} ${completedStatus}</div>
                <div><strong>Action:</strong> <span class="editable" data-field="action" data-step-index="${idx}">${markdownToHtml(step.action || "")}</span></div>
                <div><strong>Tools:</strong> <span class="editable-tools" data-field="tools" data-step-index="${idx}">${toolsHtml}</span></div>
                <div><strong>Time Estimate:</strong> <span class="editable" data-field="time_estimate" data-step-index="${idx}">${markdownToHtml(step.time_estimate || "")}</span></div>
                <div><strong>Estimated Cost:</strong> <span class="editable" data-field="estimated_cost" data-step-index="${idx}">${markdownToHtml(step.estimated_cost || "")}</span></div>
                <div><strong>Alternative:</strong> <span class="editable" data-field="alternative" data-step-index="${idx}">${markdownToHtml(step.alternative || "")}</span></div>
                <button onclick="startEditStep(${idx})" class="edit-step-btn">Edit Step</button>
                <button onclick="saveStepChanges(${idx})" class="save-step-btn hidden">Save Changes</button>
            </div>`;
        });
        preview.innerHTML = html;
    }
    
    // --- EDITING FUNCTIONALITY ---
    function startEditStep(stepIndex) {
        if (currentlyEditingStep !== null && currentlyEditingStep !== stepIndex) {
            saveStepChanges(currentlyEditingStep);
        }
        currentlyEditingStep = stepIndex;
        const stepDiv = document.getElementById(`step-preview-${stepIndex}`);
        stepDiv.querySelectorAll('.editable').forEach(span => {
            span.contentEditable = true;
        });
        const toolsSpan = stepDiv.querySelector('.editable-tools');
        const tools = workflowData.steps[stepIndex].tools;
        let toolsText = "";
        if (tools && tools.length > 0) {
            toolsText = tools.map(t => `${t.name || ""}${t.url ? ` [${t.url}]` : ''}`).join('\n');
        } else if (typeof tools === 'string') {
            toolsText = tools;
        }
        toolsSpan.innerHTML = `<textarea id="tools-editor-${stepIndex}" rows="3" style="width:95%; margin-top:5px; font-size:14px;">${toolsText.replace(/<br\s*\/?>/gi, '\n')}</textarea>
                               <small>Format: Tool Name [https://url.com] (one per line). URL is optional.</small>`;
        stepDiv.querySelector('.edit-step-btn').classList.add('hidden');
        stepDiv.querySelector('.save-step-btn').classList.remove('hidden');
    }

    function saveStepChanges(stepIndex) {
        if(stepIndex === null) return;
        const stepDiv = document.getElementById(`step-preview-${stepIndex}`);
        const step = workflowData.steps[stepIndex];
        stepDiv.querySelectorAll('.editable[contenteditable="true"]').forEach(span => {
            const field = span.dataset.field;
            step[field] = span.innerHTML; 
            span.contentEditable = false;
        });
        const toolsTextarea = document.getElementById(`tools-editor-${stepIndex}`);
        if (toolsTextarea) {
            const lines = toolsTextarea.value.split('\n').filter(line => line.trim() !== '');
            step.tools = lines.map(line => {
                const match = line.match(/^(.*?)\[(https?:\/\/[^\]]+)\]$/);
                if (match) return { name: match[1].trim(), url: match[2].trim() };
                const simpleUrlMatch = line.match(/^(.*?)\s*(https?:\/\/\S+)$/);
                if (simpleUrlMatch && simpleUrlMatch[1].trim().length > 0) {
                    return { name: simpleUrlMatch[1].trim(), url: simpleUrlMatch[2].trim() };
                }
                return { name: line.trim(), url: null };
            });
        }
        currentlyEditingStep = null;
        saveStateToLocalStorage();
        renderWorkflowPreview();
        const editedStepElement = document.getElementById(`step-preview-${stepIndex}`);
        if (editedStepElement) editedStepElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    // --- DOWNLOAD WORKFLOW PDF ---
    function downloadWorkflowPDF() {
        if (!workflowData || !workflowData.steps) { alert("No workflow to download."); return; }
        const { jsPDF } = window.jspdf;
        if (!jsPDF) { alert("PDF library (jsPDF) not loaded."); return; }
        const doc = new jsPDF();
        let yPos = 15;
        const PADDING = 15;
        const PAGE_WIDTH = doc.internal.pageSize.getWidth();
        const TEXT_WIDTH = PAGE_WIDTH - 2 * PADDING;
        const addText = (text, size, style, spacing = 5) => {
            if (yPos + spacing > doc.internal.pageSize.getHeight() - PADDING) { doc.addPage(); yPos = PADDING; }
            doc.setFontSize(size).setFont(undefined, style);
            const lines = doc.splitTextToSize(text, TEXT_WIDTH);
            doc.text(lines, PADDING, yPos);
            yPos += (lines.length * (size * 0.35)) + spacing;
        };
        addText(workflowData.workflowTitle || "Workflow Plan", 18, "bold", 8);
        if (workflowData.summary) addText(`Summary: ${workflowData.summary.replace(/<[^>]*>?/gm, '')}`, 10, "italic", 7);
        if (workflowData.total_estimated_cost) addText(`Total Estimated Cost: ${workflowData.total_estimated_cost.replace(/<[^>]*>?/gm, '')}`, 10, "normal", 10);
        workflowData.steps.forEach((step, idx) => {
            addText(`Step ${step.step_number || (idx + 1)}${step.completed ? ' (Completed)' : ''}`, 14, "bold", 6);
            const cleanHtml = (htmlStr) => htmlStr ? htmlStr.replace(/<[^>]*>?/gm, '') : "N/A";
            if (step.action) addText(`Action: ${cleanHtml(step.action)}`, 10, "normal");
            if (step.tools && step.tools.length > 0) {
                let toolsText = "Tools:\n";
                step.tools.forEach(t => {
                    toolsText += `  - ${cleanHtml(t.name)}${t.url ? ` (${t.url})` : ''}\n`;
                });
                addText(toolsText, 10, "normal");
            } else if (typeof step.tools === 'string') {
                 addText(`Tools: ${cleanHtml(step.tools)}`, 10, "normal");
            } else {
                 addText(`Tools: N/A`, 10, "normal");
            }
            if (step.time_estimate) addText(`Time Estimate: ${cleanHtml(step.time_estimate)}`, 10, "normal");
            if (step.estimated_cost) addText(`Estimated Cost: ${cleanHtml(step.estimated_cost)}`, 10, "normal");
            if (step.alternative) addText(`Alternative: ${cleanHtml(step.alternative)}`, 10, "normal");
            yPos += 5;
        });
        doc.save((workflowData.workflowTitle || "workflow").replace(/\s+/g, '_') + ".pdf");
    }

    // --- DOWNLOAD WORKFLOW JSON ---
    function downloadWorkflowJSON() {
        if (!workflowData) { alert("No workflow to download."); return; }
        const jsonString = JSON.stringify(workflowData, null, 2);
        const blob = new Blob([jsonString], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = (workflowData.workflowTitle || "workflow").replace(/\s+/g, '_') + ".json";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    // --- DOWNLOAD COACH CHAT PDF ---
    function downloadCoachPDF() {
        const { jsPDF } = window.jspdf;
        if (!jsPDF) { alert("PDF library (jsPDF) not loaded."); return; }
        const doc = new jsPDF();
        let text = "Coach Chat Log\n\n";
        const chatDiv = document.getElementById('chatMessages');
        const messages = [];
        chatDiv.childNodes.forEach(node => {
            if (node.textContent) messages.push(node.textContent);
        });
        text += messages.join('\n') || chatDiv.innerText || "No chat messages.";
        const lines = doc.splitTextToSize(text, 180);
        doc.text(lines, 10, 10);
        doc.save("coach_advice.pdf");
    }

    // --- COACH MODE ---
    function enterCoachMode() {
        if (!workflowData || !workflowData.steps || workflowData.steps.length === 0) {
             alert("Please generate a workflow first."); return;
        }
        document.getElementById('inputSection').classList.add('hidden');
        document.getElementById('workflowPreview').classList.add('hidden');
        document.getElementById('coachModeBtn').classList.add('hidden');
        document.getElementById('downloadButtons').classList.add('hidden');
        document.getElementById('coachMode').classList.remove('hidden');
        const clearBtn = document.getElementById('clearStorageBtn');
        if(clearBtn) clearBtn.classList.add('hidden'); 
        renderCurrentStep();
        document.getElementById('chatMessages').innerHTML = '';
        document.getElementById('chatInput').value = '';
    }
    function exitCoachMode() {
        document.getElementById('coachMode').classList.add('hidden');
        document.getElementById('inputSection').classList.remove('hidden');
        document.getElementById('workflowPreview').classList.remove('hidden');
        document.getElementById('coachModeBtn').classList.remove('hidden');
        document.getElementById('downloadButtons').classList.remove('hidden');
        const clearBtn = document.getElementById('clearStorageBtn');
        if(clearBtn) clearBtn.classList.remove('hidden');
        renderWorkflowPreview();
    }
    function renderCurrentStep() {
        if (!workflowData || !workflowData.steps || !workflowData.steps[currentStepIndex]) {
            document.getElementById('currentStep').innerHTML = "No step data available.";
            return;
        }
        const step = workflowData.steps[currentStepIndex];
        let toolsHtml = "N/A";
        if (step.tools && step.tools.length > 0) {
            toolsHtml = "<ul>";
            step.tools.forEach(tool => {
                toolsHtml += `<li>${tool.url ? `<a href="${tool.url}" target="_blank" rel="noopener">${markdownToHtml(tool.name)}</a>` : markdownToHtml(tool.name)}</li>`;
            });
            toolsHtml += "</ul>";
        } else if (typeof step.tools === 'string' && step.tools) {
             toolsHtml = markdownToHtml(step.tools);
        }
        const completedText = step.completed ? '<span class="step-status">✅ Completed</span>' : '';
        document.getElementById('currentStep').innerHTML = `
            <div class="step-title">Step ${step.step_number || (currentStepIndex + 1)} ${completedText}</div>
            <div><strong>Action:</strong> ${markdownToHtml(step.action || "")}</div>
            <div><strong>Tools:</strong> ${toolsHtml}</div>
            <div><strong>Time Estimate:</strong> ${markdownToHtml(step.time_estimate || "")}</div>
            <div><strong>Estimated Cost:</strong> ${markdownToHtml(step.estimated_cost || "")}</div>
            <div><strong>Alternative:</strong> ${markdownToHtml(step.alternative || "")}</div>
        `;
    }
    function previousStep() {
        if (currentStepIndex > 0) {
            currentStepIndex--;
            renderCurrentStep();
            document.getElementById('chatMessages').innerHTML = '';
            saveStateToLocalStorage();
        }
    }
    function nextStep() {
        if (workflowData && currentStepIndex < workflowData.steps.length - 1) {
            currentStepIndex++;
            renderCurrentStep();
            document.getElementById('chatMessages').innerHTML = '';
            saveStateToLocalStorage();
        } else if (workflowData && currentStepIndex === workflowData.steps.length - 1) {
            alert("You've reached the end of the workflow!");
        }
    }
    function completeCurrentStep() {
        if (workflowData && workflowData.steps[currentStepIndex]) {
            workflowData.steps[currentStepIndex].completed = !workflowData.steps[currentStepIndex].completed;
            renderCurrentStep();
            saveStateToLocalStorage();
        }
    }

    // --- COACH CHAT ---
    async function sendCoachMessage() {
        var input = document.getElementById('chatInput');
        var message = input.value.trim();
        if (!message) return;
        var chatMessages = document.getElementById('chatMessages');
        chatMessages.innerHTML += `<div style="margin-bottom:8px; text-align: right; margin-left: 20%;"><strong>You:</strong> ${markdownToHtml(message)}</div>`;
        input.value = '';
        chatMessages.scrollTop = chatMessages.scrollHeight;

        if (!workflowData || !workflowData.steps[currentStepIndex]) {
            chatMessages.innerHTML += '<div style="color:red;">Error: No current step context available.</div>';
            return;
        }
        var step = workflowData.steps[currentStepIndex];
        var context = 
            `Goal: ${workflowData.workflowTitle || 'N/A'}\n` +
            `Current Step (${step.step_number || currentStepIndex + 1}):\n` +
            `Action: ${step.action || ""}\n` +
            `Tools: ${(step.tools && step.tools.length > 0 ? step.tools.map(t => t.name + (t.url ? ` (${t.url})` : '')).join(', ') : (typeof step.tools === 'string' ? step.tools : "N/A"))}\n` +
            `Time Estimate: ${step.time_estimate || ""}\n` +
            `Estimated Cost: ${step.estimated_cost || ""}\n` +
            `Alternative: ${step.alternative || ""}`;
        
        const typingIndicator = document.createElement('div');
        typingIndicator.style.color = '#888';
        typingIndicator.innerHTML = 'Coach is typing...';
        chatMessages.appendChild(typingIndicator);
        chatMessages.scrollTop = chatMessages.scrollHeight;

        try {
            const res = await fetch(`${backendBaseUrl}/coach-chat`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ user_message: message, step_context: context })
            });
             if (!res.ok) {
                const errorData = await res.json();
                throw new Error(errorData.detail || `HTTP error! Status: ${res.status}`);
            }
            const data = await res.json();
            typingIndicator.remove();
            chatMessages.innerHTML += `<div style="margin-bottom:8px; text-align: left; margin-right: 20%;"><strong>Coach:</strong> ${markdownToHtml(data.reply)}</div>`;
            chatMessages.scrollTop = chatMessages.scrollHeight;
        } catch (e) {
            typingIndicator.remove();
            chatMessages.innerHTML += `<div style="color:red;">Error contacting AI coach: ${e.message}</div>`;
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    }

    // --- LOCAL STORAGE ---
    function saveStateToLocalStorage() {
        if (workflowData) {
            localStorage.setItem('workflowApp_workflowData', JSON.stringify(workflowData));
        }
        localStorage.setItem('workflowApp_currentStepIndex', currentStepIndex.toString());
        // manageClearStorageButton(); // Call here if any save action should update button state
    }

    function loadStateFromLocalStorage() {
        const savedWorkflowData = localStorage.getItem('workflowApp_workflowData');
        if (savedWorkflowData) {
            workflowData = JSON.parse(savedWorkflowData);
            if (workflowData && workflowData.steps) {
                workflowData.steps.forEach(step => {
                    if (typeof step.completed === 'undefined') step.completed = false;
                });
            }
            currentStepIndex = parseInt(localStorage.getItem('workflowApp_currentStepIndex') || '0', 10);
            renderWorkflowPreview();
            document.getElementById('workflowPreview').classList.remove('hidden');
            document.getElementById('coachModeBtn').classList.remove('hidden');
            document.getElementById('downloadButtons').classList.remove('hidden');
            console.log("State loaded from local storage.");
        } else {
            console.log("No saved state found in local storage.");
        }
        manageClearStorageButton(); // <--- Called after attempting to load state
    }
    
    document.getElementById('chatInput').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            sendCoachMessage();
        }
    });
    
    window.onload = () => {
        applySavedTheme();
        renderRoleButtons(); // Render role buttons on load
        loadStateFromLocalStorage();
    };
</script>